{{ if eq .chezmoi.os "linux" -}}
#!/bin/sh

set -e  # Exit on error

echo "[-] Starting package installation for Linux [-]"

{{- if (eq .chezmoi.osRelease.id "almalinux" "fedora") }}
echo "[-] Installing packages using DNF (AlmaLinux/Fedora) [-]"
{{ range .packages.linux.dnfs -}}
{{- if and (eq . "code") $.wsl }}
echo "Skipping {{ . }} on WSL (use VS Code on Windows host with WSL extension)"
{{- else }}
if ! rpm -q {{ . | quote }} >/dev/null 2>&1; then
    echo "Installing {{ . }}..."
    sudo dnf install -y {{ . | quote }} || echo "Warning: Failed to install {{ . }}"
else
    echo "{{ . }} is already installed"
fi
{{- end }}
{{ end -}}
{{- end }}

{{- if (eq .chezmoi.osRelease.id "debian" "ubuntu" "pop") }}
echo "[-] Updating package lists [-]"
sudo apt update

echo "[-] Installing packages using APT [-]"
{{ range .packages.linux.apts -}}
{{- if and (eq . "code") $.wsl }}
echo "Skipping {{ . }} on WSL (use VS Code on Windows host with WSL extension)"
{{- else }}
if ! dpkg -l {{ . | quote }} >/dev/null 2>&1; then
    echo "Installing {{ . }}..."
    sudo apt install -y {{ . | quote }}
else
    echo "{{ . }} is already installed"
fi
{{- end }}
{{ end -}}
{{- end }}

{{- if (eq .chezmoi.osRelease.id "fedora" "pop") }}
echo "[-] Installing Flatpak applications [-]"
{{ range .packages.linux.flatpak -}}
if ! flatpak list | grep -q {{ . | quote }}; then
    echo "Installing {{ . }}..."
    flatpak install -y {{ . | quote }}
else
    echo "{{ . }} is already installed"
fi
{{ end -}}

{{- if not .wsl }}
echo "[-] Installing VS Code extensions [-]"
{{ range .extensions.linux.vscode }}
if ! code --list-extensions | grep -q {{ . | quote }}; then
    echo "Installing extension {{ . }}..."
    code --force --install-extension {{ . | quote }}
else
    echo "Extension {{ . }} is already installed"
fi
{{ end }}
{{- else }}
echo "Skipping VS Code extensions on WSL (manage extensions through VS Code on Windows host)"
{{- end }}
{{- end }}

echo "[-] Package installation completed [-]"
{{ end -}}
